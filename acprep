#!/bin/sh

export AUTOCONF_VERSION=2.61
export AUTOMAKE_VERSION=1.9

touch AUTHORS COPYING ChangeLog

cmd=$(which glibtoolize 2>&1)
if [ -x "$cmd" ]; then
    export LIBTOOLIZE="$cmd"
fi
autoreconf --force --install

HERE="$PWD"

if [ ! "$1" = "--local" ]; then
    if [ -d "$HOME/Products" ]; then
	projdir="$HOME/Products/$(basename $HERE)"
	if [ ! -d "$projdir" ]; then
	    mkdir -p "$projdir"
	fi
	cd "$projdir" || (echo "Cannot change to $projdir"; exit 1)
    fi
else
    shift 1
fi

INCDIRS="-I/opt/local/include -I/usr/local/include -I/usr/include/httpd/xml"
INCDIRS="$INCDIRS -I/opt/local/include/libofx"
INCDIRS="$INCDIRS -I/usr/include/python2.5"
LIBDIRS="-L/opt/local/lib -L/usr/local/lib"

SYSTEM=`uname -s`

if [ $SYSTEM = Linux ]; then
    CXXFLAGS="-pthread"
elif [ $SYSTEM = Solaris ]; then
    CXXFLAGS="-pthreads"
elif [ $SYSTEM = Darwin ]; then
    #CXXFLAGS="-arch i386 -arch ppc -isysroot /Developer/SDKs/MacOSX10.4u.sdk"
    CXXFLAGS="$CXXFLAGS -Wno-long-double"
    #LIBDIRS="$LIBDIRS -arch i386 -arch ppc -isysroot /Developer/SDKs/MacOSX10.4u.sdk"
else
    CXXFLAGS=""
fi

if [ "$1" = "--debug" ]; then
    shift 1
    $HERE/configure CPPFLAGS="$INCDIRS" LDFLAGS="$LIBDIRS" \
	CXXFLAGS="$CXXFLAGS -g" --enable-debug --enable-python "$@"
elif [ "$1" = "--opt" ]; then
    shift 1
    $HERE/configure CPPFLAGS="$INCDIRS" LDFLAGS="$LIBDIRS" \
	CXXFLAGS="$CXXFLAGS -fomit-frame-pointer -O3 -mcpu=7450 -fPIC" "$@"
elif [ "$1" = "--flat-opt" ]; then
    shift 1
    $HERE/configure CPPFLAGS="$INCDIRS" LDFLAGS="$LIBDIRS" \
	CXXFLAGS="$CXXFLAGS -fomit-frame-pointer -O3 -mcpu=7450" "$@"
elif [ "$1" = "--safe-opt" ]; then
    shift 1
    $HERE/configure CPPFLAGS="$INCDIRS" LDFLAGS="$LIBDIRS" \
	CXXFLAGS="$CXXFLAGS -fomit-frame-pointer -O3 -mcpu=7450 -fPIC -DDEBUG_LEVEL=1" "$@"
elif [ "$1" = "--perf" ]; then
    shift 1
    $HERE/configure CPPFLAGS="$INCDIRS" LDFLAGS="$LIBDIRS" \
	CXXFLAGS="$CXXFLAGS -g -pg" "$@"
elif [ "$1" = "--python" ]; then
    shift 1
    $HERE/configure CPPFLAGS="$INCDIRS" LDFLAGS="$LIBDIRS" \
	CXXFLAGS="$CXXFLAGS -g" --enable-python "$@"
else
    $HERE/configure CPPFLAGS="$INCDIRS" LDFLAGS="$LIBDIRS" \
	CXXFLAGS="$CXXFLAGS -g" "$@"
fi

rm -f AUTHORS COPYING
